import{j as e}from"./ui-vendor-DeL-jnW0.js";import{h as de,u as me,r as l}from"./react-vendor-BRxAXmoz.js";import{A as he,i as F}from"./index-DDGz3ZKc.js";import{s as t,L as fe}from"./Leaderboard-B_Ea0e3c.js";import{s as c,C as j,S as xe,T as pe,d as Y,B as Q,P as D,c as A,L as _,e as T,A as M,f as O,g as se,h as re,i as je}from"./antd-vendor-DXVleyxb.js";import"./socket-vendor-TjCxX7sJ.js";const{Title:y}=pe,we=()=>{var Z,ee;const{code:o}=de(),g=me(),{auth:a}=l.useContext(he),[m,G]=l.useState({createdBy:null}),[W,U]=l.useState(null),[J,L]=l.useState(!0),[z,k]=l.useState([]),[w,R]=l.useState(!1),[f,P]=l.useState(0),[q,H]=l.useState([]),[u,N]=l.useState(""),[h,C]=l.useState(30),[I,$]=l.useState(30),[S,B]=l.useState(!1),[ye,V]=l.useState(0),[E,K]=l.useState(!1),[b,te]=l.useState(!1),[ie,X]=l.useState(!1),d=l.useRef(null),ne=async()=>{var s,r;try{L(!0);const i=(await F.get(`https://minor-quiz-board-backend-nyphhuy7l-prakhars-projects-415595c3.vercel.app/api/quiz/${o}`)).data;if(!i)throw new Error("Quiz not found");const x=i.creatorName===a.username;console.log("=== Quiz Data Debug ==="),console.log("Quiz Data:",i),console.log("Current username:",a.username),console.log("Quiz creatorName:",i.creatorName),console.log("Is creator?",x),G(i),H(i.questions||[]),R(i.status==="active"),te(x),x&&i.status==="active"&&X(!0),console.log("Creator status set to:",x),i.participants&&k(i.participants),U(null)}catch(n){console.error("Failed to fetch quiz details:",n);const i=((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.error)||"Failed to load quiz";U(i),c.error(i)}finally{L(!1)}};l.useEffect(()=>{if(!a.userId){c.error("Please login to join the quiz"),g("/login");return}o&&ne()},[o,a.userId,g]),l.useEffect(()=>(t.connected||t.connect(),t.emit("join-room",{code:o,username:a.username,userId:a.userId}),t.on("quiz-ended",s=>{console.log("Quiz ended event received",s),K(!0),G(r=>r&&{...r,status:"completed"}),s.finalScores&&localStorage.setItem(`quiz_${o}_final_scores`,JSON.stringify(s.finalScores)),localStorage.setItem(`quiz_${o}_code`,o),c.info("Quiz has ended. Redirecting to leaderboard..."),setTimeout(()=>{g(`/leaderboard/${o}`)},1500)}),t.on("quiz-error",s=>{c.error(s.message)}),t.on("player-joined",s=>{k(r=>r.some(i=>i.userId===s.userId)?r:[...r,s]),c.info(`${s.username} joined the quiz`)}),t.on("player-list",s=>{k(s)}),t.on("player-left",s=>{k(r=>r.filter(n=>n.userId!==s.userId)),c.info(`${s.username} left the quiz`)}),t.on("quiz-started",s=>{var r;if(console.log("Quiz started event received",s),R(!0),s.questions){H(s.questions),P(0);const n=((r=s.questions[0])==null?void 0:r.timeLimit)||30;C(n),$(n)}B(!1),N("")}),t.on("next-question",s=>{if(console.log("Next question received",s),d.current&&(clearInterval(d.current),d.current=null),s.question){P(s.questionNumber-1),N(""),B(!1);const r=s.question.timeLimit||30;C(r),$(r)}}),t.on("answer-result",s=>{console.log("Answer result received",s),V(s.score),s.correct?c.success(`Correct! Your current score is ${s.score}`):c.error(`Incorrect. Your current score is ${s.score}`)}),t.on("player-submitted",s=>{c.info(`${s.username} submitted their answer`)}),()=>{t.emit("leave-room",{code:o,username:a.username,userId:a.userId}),t.off("player-joined"),t.off("player-left"),t.off("player-list"),t.off("quiz-started"),t.off("quiz-ended"),t.off("quiz-error"),t.off("next-question"),t.off("answer-result"),t.off("player-submitted"),d.current&&(clearInterval(d.current),d.current=null)}),[o,a.username,a.userId,g]);const oe=async()=>{var s,r,n;if(!b||m.creatorName!==a.username){c.error("Only the quiz creator can start the quiz");return}try{const i=await F.post("/api/quiz/start",{code:o,creatorName:a.username});if(i.data.success){t.emit("start-quiz",{code:o,userId:a.userId}),R(!0),H(i.data.questions);const x=((s=i.data.questions[0])==null?void 0:s.timeLimit)||30;C(x),$(x),X(!0),c.success("Quiz started successfully!")}}catch(i){console.error("Failed to start quiz:",i),c.error(((n=(r=i.response)==null?void 0:r.data)==null?void 0:n.error)||"Failed to start quiz")}};l.useEffect(()=>{if(w&&!E)return console.log("Starting timer with",h,"seconds"),d.current&&clearInterval(d.current),d.current=setInterval(()=>{C(s=>{const r=s-1;return r<=0?(clearInterval(d.current),d.current=null,b&&le(),0):r})},1e3),()=>{console.log("Clearing timer interval"),d.current&&(clearInterval(d.current),d.current=null)}},[w,E,f]);const ae=async()=>{if(!u&&Array.isArray(u)&&u.length===0){c.warning("Please select an answer");return}L(!0),B(!0);try{t.emit("submit-answer",{code:o,questionIndex:f,answer:Array.isArray(u)?u.sort().join(","):u,username:a.username,userId:a.userId});const s=await F.post("/api/quiz/submit-answer",{code:o,userId:a.userId,questionIndex:f,answer:Array.isArray(u)?u.sort().join(","):u});s.data.success&&(V(s.data.currentScore),s.data.correct?c.success(`Correct! You earned ${s.data.points} points!`):c.error(`Incorrect. The correct answer was: ${s.data.correctAnswer}`))}catch(s){console.error("Failed to submit answer:",s),c.error("Failed to submit answer")}finally{L(!1)}},ce=async()=>{var s,r,n,i,x;if(!b){c.error("Only the quiz creator can end the quiz");return}try{console.log("Attempting to end quiz with code:",o);const v=await F.post(`/api/quiz/${o}/end`,{code:o,createdBy:m.createdBy,userId:a.userId});v.data.success&&(t.emit("end-quiz",{code:o,createdBy:m.createdBy,userId:a.userId,finalScores:v.data.leaderboard}),K(!0),c.success("Quiz ended successfully"),setTimeout(()=>{g(`/leaderboard/${o}`)},1e3))}catch(v){console.error("Failed to end quiz:",v),((s=v.response)==null?void 0:s.status)===403?c.error("Only quiz creator can end the quiz"):((r=v.response)==null?void 0:r.status)===400?c.error("Quiz is already completed"):((n=v.response)==null?void 0:n.status)===404?c.error("Quiz not found"):c.error(((x=(i=v.response)==null?void 0:i.data)==null?void 0:x.error)||"Failed to end quiz")}},p=q[f]||{},le=async()=>{var s;if(f>=q.length-1)console.log("Last question completed, ending quiz"),await ce();else{const r=f+1;t.emit("move-to-next-question",{code:o,questionNumber:r+1,question:q[r]}),P(r),N(""),B(!1);const n=((s=q[r])==null?void 0:s.timeLimit)||30;C(n),$(n)}};if(J)return e.jsx("div",{className:"quiz-container",children:e.jsx(j,{className:"quiz-card",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(xe,{size:"large"}),e.jsx(y,{level:4,style:{marginTop:"20px"},children:"Loading Quiz..."})]})})});if(W)return e.jsx("div",{className:"quiz-container",children:e.jsx(j,{className:"quiz-card",children:e.jsx(Y,{status:"error",title:"Failed to load quiz",subTitle:W,extra:[e.jsx(Q,{type:"primary",onClick:()=>g("/home"),children:"Back Home"},"home")]})})});if(!m)return e.jsx("div",{className:"quiz-container",children:e.jsx(j,{className:"quiz-card",children:e.jsx(Y,{status:"404",title:"Quiz Not Found",subTitle:"The quiz you're looking for doesn't exist.",extra:[e.jsx(Q,{type:"primary",onClick:()=>g("/home"),children:"Back Home"},"home")]})})});if(b&&w&&ie)return e.jsx("div",{className:"quiz-container",children:e.jsx(j,{className:"quiz-card",title:e.jsx(A,{align:"center",style:{width:"100%",justifyContent:"space-between"},children:e.jsxs(y,{level:3,children:[m.title," - Host View"]})}),children:E?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx(Y,{status:"success",title:"Quiz Completed!",subTitle:"Redirecting to the final leaderboard..."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"quiz-progress",children:[e.jsxs(y,{level:4,children:["Question ",f+1," of ",q.length]}),e.jsx(D,{percent:(f+1)/q.length*100,status:"active",format:()=>`${f+1}/${q.length}`}),e.jsxs("div",{className:"timer-section",children:[e.jsx(D,{percent:h/I*100,status:h<5?"exception":"active",showInfo:!1,strokeColor:h>I*.5?"#52c41a":h>I*.2?"#faad14":"#f5222d"}),e.jsxs("div",{className:"time-display",children:["Time Left: ",e.jsxs("span",{className:h<=5?"time-critical":"",children:[h,"s"]})]})]}),e.jsxs(j,{className:"current-question-card",style:{marginBottom:"20px"},children:[e.jsx(y,{level:5,children:"Current Question:"}),e.jsx("p",{children:p.text}),e.jsxs("p",{children:[e.jsx("strong",{children:"Correct Answer:"})," ",Array.isArray(p.correctAnswer)?p.correctAnswer.join(", "):p.correctAnswer]})]})]}),e.jsx(fe,{code:o,live:!0,isCreator:!0})]})})});const ue=()=>!b||m.creatorName!==a.username?null:e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx(O,{message:"Host Controls",description:z.length<2?"Please wait for at least 2 players to join before starting the quiz.":"You can now start the quiz. All players are ready!",type:z.length<2?"warning":"success",showIcon:!0,style:{marginBottom:"20px"}}),e.jsx(Q,{type:"primary",size:"large",block:!0,onClick:oe,disabled:z.length<2,style:{height:"50px",fontSize:"18px",backgroundColor:z.length<2?"#d9d9d9":"#1890ff"},icon:e.jsx(je,{}),children:z.length<2?"Waiting for Players...":"Start Quiz Now"})]});return w?e.jsx("div",{className:"quiz-container",children:e.jsx(j,{className:"quiz-card",title:e.jsx(A,{align:"center",style:{width:"100%",justifyContent:"space-between"},children:e.jsx(y,{level:3,children:m.title})}),children:e.jsxs("div",{className:"quiz-content",children:[w&&!E&&e.jsxs("div",{className:"timer-section",children:[e.jsx(D,{percent:h/I*100,status:h<5?"exception":"active",showInfo:!1,strokeColor:h>I*.5?"#52c41a":h>I*.2?"#faad14":"#f5222d"}),e.jsxs("div",{className:"time-display",children:["Time Left: ",e.jsxs("span",{className:h<=5?"time-critical":"",children:[h,"s"]})]})]}),e.jsxs("div",{className:"question-card",children:[e.jsxs("div",{className:"question-header",children:[e.jsxs(y,{level:4,children:["Question ",f+1," of ",q.length]}),e.jsx(y,{level:3,children:p.text})]}),p.type==="single"&&e.jsx(se.Group,{onChange:s=>N(s.target.value),value:u,disabled:S,className:"options-container",children:(Z=p.options)==null?void 0:Z.map((s,r)=>e.jsx(se,{value:s,children:e.jsx(j,{hoverable:!S,className:`option-card ${u===s?"selected":""}`,children:s})},r))}),p.type==="multiple"&&e.jsx(re.Group,{onChange:N,value:u,disabled:S,className:"options-container",children:(ee=p.options)==null?void 0:ee.map((s,r)=>e.jsx(re,{value:s,children:e.jsx(j,{hoverable:!S,className:`option-card ${u!=null&&u.includes(s)?"selected":""}`,children:s})},r))})]}),e.jsx("div",{className:"submit-section",children:S?e.jsx(O,{message:"Answer Submitted",description:"Waiting for the timer to complete. The next question will appear automatically.",type:"success",showIcon:!0}):e.jsx(Q,{type:"primary",size:"large",onClick:ae,disabled:!u||Array.isArray(u)&&u.length===0,loading:J,children:"Submit Answer"})})]})})}):e.jsxs("div",{className:"quiz-container",children:[e.jsx(j,{title:e.jsxs(A,{children:[e.jsx(y,{level:3,children:m.title||"Quiz Lobby"}),e.jsxs(T,{color:"blue",children:["Code: ",o]}),a.userId===m.createdBy&&e.jsx(T,{color:"gold",children:"You are the host"})]}),className:"quiz-card",extra:e.jsxs(A,{children:[e.jsxs(T,{color:"cyan",children:["Created by: ",m.creatorName]}),e.jsx(M.Group,{maxCount:2,children:z.map(s=>{var r,n;return e.jsx(M,{children:(n=(r=s.username)==null?void 0:r[0])==null?void 0:n.toUpperCase()},s.userId)})}),e.jsxs("span",{children:["Players: ",z.length]})]}),children:e.jsxs("div",{className:"quiz-lobby",children:[ue(),e.jsxs("div",{className:"players-list",children:[e.jsx(y,{level:4,children:"Players in Lobby"}),e.jsx(_,{dataSource:z,renderItem:s=>{var r,n;return e.jsx(_.Item,{children:e.jsx(_.Item.Meta,{avatar:e.jsx(M,{style:{backgroundColor:s.userId===m.createdBy?"#f56a00":"#1890ff"},children:(n=(r=s.username)==null?void 0:r[0])==null?void 0:n.toUpperCase()}),title:e.jsxs(A,{children:[s.username,s.userId===a.userId&&e.jsx(T,{color:"green",children:"You"}),s.userId===m.createdBy&&e.jsx(T,{color:"orange",children:"Host"})]})})})}})]}),(!b||a.userId!==m.createdBy)&&e.jsx(O,{message:"Waiting for host to start the quiz...",type:"info",showIcon:!0})]})}),e.jsx(Q,{type:"primary",onClick:()=>g("/home"),children:"Back to Home"},"home")]})};export{we as default};
